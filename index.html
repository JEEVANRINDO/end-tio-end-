<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secure Private Chat</title>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
    <style>
        *{margin:0;padding:0;box-sizing:border-box;}
        :root{--whatsapp-green:#25D366;--whatsapp-dark:#075E54;--whatsapp-light:#128C7E;--chat-bg:#e5ddd5;--message-sent:#dcf8c6;--message-received:#ffffff;--border-color:#e0e0e0;--error-color:#e74c3c;--warning-color:#f39c12;}
        body{font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;background:var(--chat-bg);height:100vh;overflow:hidden;}
        .screen{display:none;height:100vh;width:100%;}
        .screen.active{display:flex;flex-direction:column;}
        #auth-screen{background:linear-gradient(135deg,var(--whatsapp-dark)0%,var(--whatsapp-light)100%);justify-content:center;align-items:center;}
        .auth-container{background:white;padding:2.5rem;border-radius:16px;box-shadow:0 20px 40px rgba(0,0,0,0.1);width:90%;max-width:400px;text-align:center;}
        .auth-form input{width:100%;padding:14px;margin:10px 0;border:2px solid var(--border-color);border-radius:8px;font-size:16px;}
        .auth-buttons button{width:100%;padding:14px;margin:8px 0;border:none;border-radius:8px;font-size:16px;font-weight:600;cursor:pointer;}
        #signup-btn{background:var(--whatsapp-green);color:white;}
        #signin-btn{background:var(--whatsapp-dark);color:white;}
        .security-indicator{display:flex;align-items:center;gap:8px;padding:8px 12px;background:#e8f5e8;border-radius:8px;margin:10px 0;font-size:0.8rem;color:#2e7d32;}
        .security-warning{background:#ffebee;color:#c62828;}
        .key-management{background:#f3e5f5;border-radius:8px;padding:1rem;margin:1rem 0;}
        .key-fingerprint{font-family:monospace;word-break:break-all;background:white;padding:8px;border-radius:4px;margin:8px 0;font-size:0.7rem;}
        .verification-section{border:2px solid #4caf50;border-radius:8px;padding:1rem;margin:1rem 0;background:#f1f8e9;}
        .device-list{margin:1rem 0;}
        .device-item{padding:0.5rem;border:1px solid #ddd;border-radius:4px;margin:0.5rem 0;background:white;}
        .verified-badge{color:#4caf50;font-weight:bold;}
        .warning-badge{color:#ff9800;font-weight:bold;}
        .passphrase-input{width:100%;padding:12px;margin:8px 0;border:2px solid var(--border-color);border-radius:8px;}
        .message-verified{color:#4caf50;font-size:0.7rem;}
        .message-unverified{color:#ff9800;font-size:0.7rem;}
        .message-security-error{color:#f44336;font-size:0.7rem;}
        .qr-code{width:200px;height:200px;margin:1rem auto;border:2px solid #ddd;border-radius:8px;padding:10px;background:white;}
        .ratchet-status{font-size:0.7rem;color:#666;margin-top:4px;}
        #chat-screen{background:var(--chat-bg);}
        .chat-header{background:var(--whatsapp-dark);color:white;padding:1rem 1.5rem;display:flex;justify-content:space-between;align-items:center;}
        .chat-container{flex:1;display:flex;flex-direction:column;max-width:1200px;margin:0 auto;width:100%;height:calc(100vh - 80px);}
        .messages-container{flex:1;padding:1rem;overflow-y:auto;background:var(--chat-bg);}
        .message{margin:8px 0;padding:12px 16px;border-radius:8px;max-width:70%;word-wrap:break-word;animation:fadeIn 0.3s ease-in;}
        .message.sent{background:var(--message-sent);margin-left:auto;}
        .message.received{background:var(--message-received);box-shadow:0 1px 2px rgba(0,0,0,0.1);}
        .message-input-container{background:white;border-top:1px solid var(--border-color);padding:1rem;}
        .message-input{display:flex;gap:12px;align-items:center;}
        .message-input input{flex:1;padding:12px 18px;border:2px solid var(--border-color);border-radius:24px;outline:none;font-size:15px;}
        .modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);justify-content:center;align-items:center;z-index:1000;}
        .modal.active{display:flex;}
        .modal-content{background:white;padding:2rem;border-radius:12px;width:90%;max-width:500px;max-height:90vh;overflow-y:auto;}
        .error-message{color:var(--error-color);margin-top:1rem;}
        .hidden{display:none;}
        .text-center{text-align:center;}
        .mt-2{margin-top:1rem;}
        .mb-2{margin-bottom:1rem;}
        @keyframes fadeIn{from{opacity:0;transform:translateY(10px);}to{opacity:1;transform:translateY(0);}}
    </style>
</head>
<body>
    <div id="auth-screen" class="screen active">
        <div class="auth-container">
            <div class="app-logo">
                <h1>üîí Secure Private Chat</h1>
                <p>Military Grade End-to-End Encryption</p>
            </div>
            <div class="auth-form">
                <input type="email" id="email" placeholder="Email address" value="test@example.com">
                <input type="password" id="password" placeholder="Password" value="123456">
                <div class="auth-buttons">
                    <button id="signup-btn">Create Account</button>
                    <button id="signin-btn">Sign In</button>
                </div>
            </div>
            <div id="auth-error" class="error-message"></div>
        </div>
    </div>

    <div id="passphrase-screen" class="screen">
        <div class="auth-container">
            <h2>üîê Set Encryption Passphrase</h2>
            <p>This passphrase protects your encryption keys. You'll need it to access your messages.</p>
            <div class="key-management">
                <input type="password" id="passphrase" class="passphrase-input" placeholder="Enter a strong passphrase">
                <input type="password" id="passphrase-confirm" class="passphrase-input" placeholder="Confirm passphrase">
                <div class="security-indicator">
                    <span>üîí</span>
                    <span>Your passphrase is never sent to the server</span>
                </div>
                <button id="setup-encryption-btn">Setup Encryption</button>
            </div>
        </div>
    </div>

    <div id="unlock-screen" class="screen">
        <div class="auth-container">
            <h2>üîê Unlock Encryption</h2>
            <p>Enter your passphrase to decrypt your messages</p>
            <div class="key-management">
                <input type="password" id="unlock-passphrase" class="passphrase-input" placeholder="Enter your passphrase">
                <div id="unlock-error" class="error-message"></div>
                <button id="unlock-btn">Unlock</button>
                <div class="security-indicator">
                    <span>üîÑ</span>
                    <span><a href="#" id="reset-encryption-link">Reset encryption keys</a> (will lose access to old messages)</span>
                </div>
            </div>
        </div>
    </div>

    <div id="verification-screen" class="screen">
        <div class="auth-container">
            <h2>üîç Verify Security Codes</h2>
            <p>Compare security codes with other users to prevent MITM attacks</p>
            <div class="verification-section">
                <h4>Your Security Code:</h4>
                <div class="key-fingerprint" id="user-security-code"></div>
                <div class="qr-code" id="qr-code-container"></div>
                <h4>Other Users to Verify:</h4>
                <div id="users-to-verify-list"></div>
            </div>
            <button id="complete-verification-btn">I've Verified Security Codes</button>
            <button id="skip-verification-btn" class="mt-2" style="background:#666;">Skip for Now</button>
        </div>
    </div>

    <div id="device-approval-screen" class="screen">
        <div class="auth-container">
            <h2>üì± Device Management</h2>
            <p>Review and approve your devices cryptographically</p>
            <div class="key-management">
                <h4>Your Current Device:</h4>
                <div class="key-fingerprint" id="current-device-fingerprint"></div>
                <h4>Pending Device Approvals:</h4>
                <div id="pending-devices-list"></div>
                <button id="continue-to-chat-btn" class="hidden">Continue to Chat</button>
            </div>
        </div>
    </div>

    <div id="chat-screen" class="screen">
        <div class="chat-header">
            <div class="header-info">
                <h3>üîí Secure Group Chat</h3>
                <span id="online-count">‚óè 0 online</span>
            </div>
            <div class="header-actions">
                <span id="user-name"></span>
                <button id="security-info-btn">Security</button>
                <button id="logout-btn">Logout</button>
            </div>
        </div>
        <div class="chat-container">
            <div id="messages-container" class="messages-container">
                <div class="security-indicator">
                    <span>üîí</span>
                    <span><strong>MILITARY GRADE ENCRYPTION</strong> - All messages are end-to-end encrypted and verified</span>
                </div>
                <div class="welcome-message">
                    <p>Welcome to your secure chat! Start a conversation with end-to-end encryption.</p>
                </div>
            </div>
            <div class="message-input-container">
                <div class="message-input">
                    <input type="text" id="message-input" placeholder="Type a secure message..." maxlength="1000">
                    <div class="input-buttons">
                        <button id="file-btn">üìé</button>
                        <button id="send-btn">Send</button>
                    </div>
                </div>
                <div class="input-actions">
                    <span class="char-count"><span id="char-count">0</span>/1000</span>
                    <span class="encryption-status">üîí End-to-end encrypted</span>
                </div>
            </div>
        </div>
    </div>

    <div id="security-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>üîí Security Information</h3>
                <button class="close-btn" id="close-security-modal">√ó</button>
            </div>
            <div class="security-info">
                <div class="security-indicator">
                    <span>‚úÖ</span>
                    <span><strong>Military Grade Security Active</strong></span>
                </div>
                <div class="key-management">
                    <h4>Encryption Status</h4>
                    <div id="security-status-list"></div>
                    <div class="ratchet-status" id="ratchet-status"></div>
                </div>
                <button id="verify-security-codes-btn" class="mt-2">Verify Security Codes</button>
                <button id="manage-devices-btn" class="mt-2">Manage Devices</button>
                <button id="backup-keys-btn" class="mt-2">Backup Encryption Keys</button>
                <button id="rotate-keys-btn" class="mt-2">Rotate Keys</button>
            </div>
        </div>
    </div>

<script>
    // Firebase configuration (keep your existing config)
    const firebaseConfig = {
        apiKey: "AIzaSyBCix7_qzRM8dSopBef0ORyFjvssjV32Lc",
        authDomain: "messaging-app-1bd04.firebaseapp.com",
        projectId: "messaging-app-1bd04",
        storageBucket: "messaging-app-1bd04.firebasestorage.app",
        messagingSenderId: "443693550918",
        appId: "1:443693550918:web:62cb22ffd4056014822947",
        measurementId: "G-P9EWYXGNV2"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    const storage = firebase.storage();

    // Encryption and App State Management
    let currentUser = null;
    let userDisplayName = '';
    let encryptionKeys = {}; // Stores the user's key pair locally

    // Security Configuration
    const SECURITY_CONFIG = {
        PBKDF2_ITERATIONS: 310000,
        KEY_ALGORITHM: { name: 'AES-GCM', length: 256 },
        KEY_WRAPPING_ALGORITHM: 'AES-GCM',
        MESSAGE_IV_LENGTH: 12,
        SALT_LENGTH: 16
    };

    // --- Core Crypto Functions (Web Crypto API) ---

    /**
     * Generates a master encryption key for the user.
     * This key is derived from their passphrase and is used to wrap/unwrap their actual data key.
     */
    async function deriveMasterKey(passphrase, salt) {
        const enc = new TextEncoder();
        const passphraseKey = await window.crypto.subtle.importKey(
            'raw',
            enc.encode(passphrase),
            'PBKDF2',
            false,
            ['deriveKey']
        );

        return await window.crypto.subtle.deriveKey(
            {
                name: 'PBKDF2',
                salt: salt,
                iterations: SECURITY_CONFIG.PBKDF2_ITERATIONS,
                hash: 'SHA-256'
            },
            passphraseKey,
            SECURITY_CONFIG.KEY_ALGORITHM,
            false, // Not extractable - crucial for security
            ['encrypt', 'decrypt']
        );
    }

    /**
     * Generates a new data key used for encrypting/decrypting chat messages.
     */
    async function generateDataKey() {
        return await window.crypto.subtle.generateKey(
            SECURITY_CONFIG.KEY_ALGORITHM,
            true, // This key IS extractable, so we can wrap it for storage
            ['encrypt', 'decrypt']
        );
    }

    /**
     * Wraps (encrypts) the data key using the master key for secure storage.
     */
    async function wrapDataKey(dataKey, masterKey) {
        const iv = window.crypto.getRandomValues(new Uint8Array(SECURITY_CONFIG.MESSAGE_IV_LENGTH));
        const exportedDataKey = await window.crypto.subtle.exportKey('raw', dataKey);
        const wrapped = await window.crypto.subtle.encrypt(
            { name: 'AES-GCM', iv: iv },
            masterKey,
            exportedDataKey
        );
        return {
            wrappedKey: new Uint8Array(wrapped),
            iv: iv
        };
    }

    /**
     * Unwraps (decrypts) the data key using the master key.
     */
    async function unwrapDataKey(wrappedBundle, masterKey) {
        const decrypted = await window.crypto.subtle.decrypt(
            { name: 'AES-GCM', iv: wrappedBundle.iv },
            masterKey,
            wrappedBundle.wrappedKey
        );
        return await window.crypto.subtle.importKey(
            'raw',
            decrypted,
            SECURITY_CONFIG.KEY_ALGORITHM,
            true,
            ['encrypt', 'decrypt']
        );
    }

    /**
     * Encrypts a message string using the current data key.
     */
    async function encryptMessage(message, dataKey) {
        const enc = new TextEncoder();
        const iv = window.crypto.getRandomValues(new Uint8Array(SECURITY_CONFIG.MESSAGE_IV_LENGTH));
        const encrypted = await window.crypto.subtle.encrypt(
            { name: 'AES-GCM', iv: iv },
            dataKey,
            enc.encode(message)
        );
        return {
            ciphertext: new Uint8Array(encrypted),
            iv: iv
        };
    }

    /**
     * Decrypts a message using the current data key.
     */
    async function decryptMessage(encryptedMessage, dataKey) {
        try {
            const decrypted = await window.crypto.subtle.decrypt(
                { name: 'AES-GCM', iv: encryptedMessage.iv },
                dataKey,
                encryptedMessage.ciphertext
            );
            const dec = new TextDecoder();
            return dec.decode(decrypted);
        } catch (error) {
            throw new Error('Failed to decrypt message: The key is likely incorrect or the data is corrupted.');
        }
    }

    // --- Key Storage and Management (using IndexedDB) ---

    /**
     * Saves the wrapped keys to the browser's local IndexedDB.
     */
    async function saveWrappedKeys(userId, wrappedBundle) {
        return new Promise((resolve, reject) => {
            const request = indexedDB.open('SecureChatKeys', 1);
            request.onerror = () => reject(request.error);
            request.onsuccess = () => {
                const db = request.result;
                const tx = db.transaction('keys', 'readwrite');
                const store = tx.objectStore('keys');
                const putRequest = store.put({
                    id: userId,
                    wrappedBundle: wrappedBundle,
                    createdAt: Date.now()
                });
                putRequest.onsuccess = () => resolve();
                putRequest.onerror = () => reject(putRequest.error);
            };
            request.onupgradeneeded = (event) => {
                const db = event.target.result;
                if (!db.objectStoreNames.contains('keys')) {
                    db.createObjectStore('keys', { keyPath: 'id' });
                }
            };
        });
    }

    /**
     * Loads the wrapped keys from IndexedDB.
     */
    async function loadWrappedKeys(userId) {
        return new Promise((resolve, reject) => {
            const request = indexedDB.open('SecureChatKeys', 1);
            request.onerror = () => reject(request.error);
            request.onsuccess = () => {
                const db = request.result;
                const tx = db.transaction('keys', 'readonly');
                const store = tx.objectStore('keys');
                const getRequest = store.get(userId);
                getRequest.onsuccess = () => resolve(getRequest.result ? getRequest.result.wrappedBundle : null);
                getRequest.onerror = () => reject(getRequest.error);
            };
        });
    }

    // --- Encryption Setup and Unlock Flow ---

    /**
     * The main function to set up a user's encryption system.
     * Called when a new account is created.
     */
    async function setupEncryption() {
        const passphrase = document.getElementById('passphrase').value;
        const confirmPassphrase = document.getElementById('passphrase-confirm').value;

        // Basic validation
        if (!passphrase || passphrase.length < 8) {
            alert('Passphrase must be at least 8 characters long');
            return;
        }
        if (passphrase !== confirmPassphrase) {
            alert('Passphrases do not match');
            return;
        }

        try {
            document.getElementById('setup-encryption-btn').disabled = true;
            document.getElementById('setup-encryption-btn').textContent = 'Setting Up Encryption...';

            // 1. Generate a random salt
            const salt = window.crypto.getRandomValues(new Uint8Array(SECURITY_CONFIG.SALT_LENGTH));
            
            // 2. Derive a master key from the passphrase
            const masterKey = await deriveMasterKey(passphrase, salt);
            
            // 3. Generate a new data key for message encryption
            const dataKey = await generateDataKey();
            
            // 4. Wrap the data key with the master key for storage
            const wrappedBundle = await wrapDataKey(dataKey, masterKey);
            // Add the salt to the bundle for storage
            const storageBundle = {
                wrappedKey: Array.from(wrappedBundle.wrappedKey),
                iv: Array.from(wrappedBundle.iv),
                salt: Array.from(salt)
            };

            // 5. Save the wrapped bundle to IndexedDB
            await saveWrappedKeys(currentUser.uid, storageBundle);

            // 6. Store the data key in memory for immediate use
            encryptionKeys.dataKey = dataKey;

            // 7. Generate and display a security code for verification
            const securityCode = await generateSecurityCode(dataKey);
            document.getElementById('user-security-code').textContent = securityCode;

            // Generate QR code if the library is available
            if (typeof QRCode !== 'undefined') {
                QRCode.toCanvas(document.getElementById('qr-code-container'), securityCode, function(error) {
                    if (error) console.error('QR code generation error:', error);
                });
            }

            showScreen('verification-screen');

        } catch (error) {
            console.error('Encryption setup error:', error);
            alert('Error setting up encryption: ' + error.message);
        } finally {
            document.getElementById('setup-encryption-btn').disabled = false;
            document.getElementById('setup-encryption-btn').textContent = 'Setup Encryption';
        }
    }

    /**
     * Unlocks the user's encryption system using their passphrase.
     * Called when an existing user signs in.
     */
    async function handleUnlock() {
        const passphrase = document.getElementById('unlock-passphrase').value;
        if (!passphrase) {
            showError('unlock-error', 'Please enter your passphrase');
            return;
        }

        try {
            document.getElementById('unlock-btn').disabled = true;
            document.getElementById('unlock-btn').textContent = 'Unlocking...';

            // 1. Load the wrapped bundle from storage
            const storageBundle = await loadWrappedKeys(currentUser.uid);
            if (!storageBundle) {
                throw new Error('No encrypted keys found for this user.');
            }

            // Convert arrays back to Uint8Arrays
            const wrappedBundle = {
                wrappedKey: new Uint8Array(storageBundle.wrappedKey),
                iv: new Uint8Array(storageBundle.iv)
            };
            const salt = new Uint8Array(storageBundle.salt);

            // 2. Re-derive the master key from the passphrase
            const masterKey = await deriveMasterKey(passphrase, salt);
            
            // 3. Unwrap the data key
            const dataKey = await unwrapDataKey(wrappedBundle, masterKey);
            
            // 4. Store the data key in memory for use
            encryptionKeys.dataKey = dataKey;

            showScreen('chat-screen');

        } catch (error) {
            console.error('Unlock error:', error);
            showError('unlock-error', 'Invalid passphrase or corrupted keys. Please try again.');
        } finally {
            document.getElementById('unlock-btn').disabled = false;
            document.getElementById('unlock-btn').textContent = 'Unlock';
        }
    }

    /**
     * Generates a readable security code from a crypto key.
     * Used for user verification.
     */
    async function generateSecurityCode(key) {
        const exported = await window.crypto.subtle.exportKey('raw', key);
        const hash = await window.crypto.subtle.digest('SHA-256', exported);
        const hashArray = Array.from(new Uint8Array(hash));
        return hashArray.slice(0, 6).map(b => b.toString(16).padStart(2, '0')).join('').toUpperCase();
    }

    // --- UI Helper Functions ---

    function showScreen(screenId) {
        document.querySelectorAll('.screen').forEach(screen => screen.classList.remove('active'));
        document.getElementById(screenId).classList.add('active');
    }

    function showError(elementId, message) {
        const element = document.getElementById(elementId);
        element.textContent = message;
        element.style.display = 'block';
    }

    // --- Event Listeners for Authentication Flow ---
    document.addEventListener('DOMContentLoaded', function() {
        // ... (your existing auth event listeners) ...
        document.getElementById('setup-encryption-btn').addEventListener('click', setupEncryption);
        document.getElementById('unlock-btn').addEventListener('click', handleUnlock);
    });

    // Note: The sendMessage and message decryption logic would need to be updated
    // to use the new encryptMessage and decryptMessage functions.
</script>

